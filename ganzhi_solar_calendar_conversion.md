# 干支历与西历互相转换算法

## Prerequisites

### 1.万年历

转换算法的根本依据是万年历，先实现了万年历的话，正查反查算法的实现会容易很多。

网上已经有不少万年历的库及产品，但理想的干支万年历应该包含

- 精确的二十四节气时间

虽然有成熟的算法可以得到节气时间，但与真实情况相比还是存在少许误差，因此使用NASA提供的[Horizons API](https://ssd.jpl.nasa.gov/)，用法可参考 -> https://github.com/kumkee/solarterms

- 不限时间跨度的西历以及干支日历

理想效果如下，细节详下正查算法

![](./img/sample_calendar.jpeg=500x)


### 2.五龙遁算法

该算法可以根据年/日的天干获得十二个月份/时辰的干支组合。比如：

甲己年对应的十二个月份（正月至十二月）：丙寅 丁卯 **戊辰** 己巳 庚午 辛未 壬申 癸酉 甲戌 乙亥 丙子 丁丑

甲己日对应的十二个时辰（零点至二十四点）：甲子 乙丑 丙寅 丁卯 **戊辰** 己巳 庚午 辛未 壬申 癸酉 甲戌 乙亥 丙子

可见甲己年有戊辰月，甲己日有戊辰时，即可由**戊辰**推算出剩余的干支排列。

同理另外四种天干组合：乙庚有庚辰，丙辛有壬辰，丁壬有甲辰，戊癸有丙辰。

因为均取辰字，十二生肖的龙属辰，所以此算法也叫做五龙遁算法。



## 正查算法

正查算法是通过西历（阳历）表示的日期获得干支日期的算法。一个西历日期只会对应一个干支日期，比如西历**1893.12.26 07:30**对应的干支日期就是 **癸巳 甲子 丁酉 甲辰** 。

时间默认采用东八区（UTC+8）时间，严格来说是东经120度的时间。因为一个时区的跨度为15度，每度之间有4分钟的时差。



以上述日期为例，通过万年历可以查询到1893.12.26所对应的年月日三柱分别为**癸巳 甲子 丁酉**。

根据如下时辰与24小时时间制对应关系：

子时——[23, 01) 丑时——[01, 03) 寅时——[03, 05) 卯时——[05, 07) 辰时——[07, 09) 巳时——[09, 11)

午时——[11, 13) 未时——[13, 15) 申时——[15, 17) 酉时——[17, 19) 戌时——[19, 21) 亥时——[21, 23)

07:30对应的时辰为辰时。通过五龙遁算法可得，丁酉日的辰时为**甲辰**时。



### 边界情况

- 时辰交界处

07:00:00以辰时计，06:59:59以卯时计

- 节气交界处

干支历法以每年立春为一年的开始，以惊蛰节、清明节等[十二个节](https://zh.wikipedia.org/wiki/%E8%8A%82%E6%B0%94#%E4%BA%8C%E5%8D%81%E5%9B%9B%E7%AF%80%E6%B0%A3)作为十二个月份的交界。

比如2022年壬寅年立春时间为2月4日04:50:36，那么在此之间之前则算作辛丑年，月份亦同理。因此一个完整的干支年会跟两个西历年有重叠。

- 早晚子时

中国古代以子正初刻（00:00）为一日之开始，因此子时实际上横跨了两天。24点之前的子时算作当天的子时，24点之后的子时算作次日的子时。因此同一天会出现早晚两个子时。

比如：丁酉日的早子时[00:00, 01:00）为庚子时，晚子时[23:00, 24:00）为壬子时。



## 反查算法

反查算法是通过干支日期获得西历（阳历）日期的算法。因为干支日期以六十甲子为一轮回，所以一个干支日期会对应多个西历日期。

比如**癸巳 甲子 丁酉 甲辰**对应的西历日期有**1893.12.26 07~09**, **1953.12.12 07~09**等等。

### 1.判断干支日期是否存在

对于任意一个干支四柱，可以用五龙遁算法判断这个四柱能不能对应到干支日期。

即根据年干判断月柱，根据日干判断时柱。

### 2.根据年柱获得所有可能的年份

以1984年甲子年为例，因为干支历以60年为一循环，则1924、1864年等均为甲子年。由此可获得年柱所对应的所有可能年份。

### 3.根据月柱年

因为一个干支年会与两个西历年有重叠部分，根据月柱不同，1984年甲子年会有小部分天数属于1985年，所以需要确认是否对年柱进行修正。

根据万年历，可以得到月柱对应西历的时间范围。

### 4.遍历该月获得日期

根据万年历，对该月所有的日期进行遍历，获得干支与日柱相同的那一天。
